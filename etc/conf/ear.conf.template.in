# ---------------------- #
# EAR Configuration File #
# ---------------------- #

# ------------------------------------------------------------
# DB confguration: This section sets the DB server parameters.
# ------------------------------------------------------------
DBIp=127.0.0.1

# Add a secondary IP for high availability.
# YOU MUST REMOVE OR COMMENT THIS FIELD IF YOU ARE NOT GOING TO USE A SECONDARY DB.
# EARDBD_MIRROR_IP=

# Set Database user with write rights.
DBUser=ear_daemon
DBPassw=password

# User and password for usermode querys.
DBCommandsUser=ear_commands
DBCommandsPassw=password

# Database name, server port and maximum number of allowed connections.
# (defaults: EAR/3306/20).
# DBDatabase=
# DBPort=
# DBMaxConnections=

# Periodic metrics are by default the start and end times, the average DC node
# power consumption, the node id and the job and step ids (if apply). By setting
# this flag, periodic metrics also include the average CPU frequency and
# temperature and the DRAM, PCK and GPU (if applies) average power (default: 1).
# DBReportNodeDetail=

# Extended signature information saves also the hardware counters, i.e., cache misses, FLOPS,
# instructions and cycles. (default: 1).
# DBreportSIGDetail=

# Report loop signatures (default: 1).
# THIS FIELD SHOULD BE CONSIDERED TO BE SET TO 0 IF YOU ARE INSTALLING EAR IN A LARGE CLUSTER
# DBReportLoops=

# ------------------------------------------------------------------------
# EAR Daemon (EARD): Update this section to change the EARD configuration.
# ------------------------------------------------------------------------
# Port is used for connections with the EAR plugin and commands (default: 50000).
# NodeDaemonPort=

# Frequency at wich periodic metrics are reported, in seconds (default: 60).
# NodeDaemonPowermonFreq=

# Max frequency used by eard. It's max frequency but min pstate (default: 1).
# NodeDaemonMinPstate=

# default: 0
# NodeDaemonTurbo=

# Defines whether EARD uses the DB (default: 1).
# NodeUseDB=
# Defines whether EARD connects with EARDBD to report data to the DB server (default: 1).
# Only for testing.
# NodeUseEARDBD=

# This flag sets whether the EAR must set frequencies at job beginning/end.
# If not, frequency is only changed in case job a runs with EARL (default: 1).
# NodeDaemonForceFrequencies=

# Verbosity (default: 1).
# NodeDaemonVerbose=

# When set to 1, the output is saved in 'TmpDir'/eard.log
# (common configuration) as a log file (default: 1).
# NodeUseLog=

# Set the report plug-in to be loaded (default: no plug-in).
# EARDReportPlugins=eardbd.so

# -------------------------------------------------------------------------
# EAR Database Manager (EARDBD): Update this section to change the EARDBD
# configuration.
# -------------------------------------------------------------------------
DBDaemonPortTCP=50002
DBDaemonPortSecTCP=50003
DBDaemonSyncPort=50004
# Aggregation time id frequency at which power metrics are aggregated in aggregated metrics, in seconds.
DBDaemonAggregationTime=60
# Frequency at which buffered data is sent to DB server.
DBDaemonInsertionTime=30
# Memory size expressed in MB per process (server and/or mirror) to cache the values.
DBDaemonMemorySize=120
#--------------------------------------------------------------------------------------------------
# EAR Library (EARL): These options modify internal EARL behaviour.
# Do not modify except you are an expert.
#--------------------------------------------------------------------------------------------------
CoefficientsDir=@sysconfdir@/ear/coeffs
# EAR library default report plugin
EARLReportPlugins=eard.so

#--------------------------------------------------------------------------------------------------
# EAR Global Manager (EARGMD): Update that section to use EARGM.
#--------------------------------------------------------------------------------------------------
# Verbosity
EARGMVerbose=1
# '-' are Joules, 'K' KiloJoules and 'M' MegaJoules.
EARGMUnits=K
# Period T1 and T2 are specified in seconds T1 (ex. must be less than T2, ex. 10min and 1 month)
EARGMEnergyPeriodT1=90
EARGMEnergyPeriodT2=259200
# Use aggregated periodic metrics or periodic power metrics. Aggregated metrics are only available
# when EARDBD is running
EARGMEnergyUseAggregated=1
# Two modes are supported '0=manual' and '1=automatic'.
EARGMEnergyMode=0
# T1 "grace" periods between DEFCON before re-evaluate.
EARGMEnergyGracePeriods=3
# Format for action is: command_name energy_T1 energy_T2  energy_limit T2 T1  units "
# This action is automatically executed at each warning level (only once per grace periods)
EARGMEnergyAction=no_action

#### POWERCAP definition for EARGM: Powercap is still under development. Do not activate
# Period at which the powercap thread is activated. Meta-EARGM checks the EARGMs it controls every 2*EARGMPowerPeriod
EARGMPowerPeriod=120
# Powercap mode: 0 is monitoring, 1 is hard powercap, 2 is soft powercap.
EARGMPowerCapMode=1
# Admins can specify to automatically execute a command in EARGMPowerCapSuspendAction when total_power >= EARGMPowerLimit*EARGMPowerCapResumeLimit/100
EARGMPowerCapSuspendLimit=90
# Format for action is: command_name current_power current_limit total_idle_nodes total_idle_power 
EARGMPowerCapSuspendAction=no_action
# Admins can specify to automatically execute a command in EARGMPowerCapResumeAction to undo EARGMPowerCapSuspendAction
# when total_power >= EARGMPowerLimit*EARGMPowerCapResumeLimit/100. Note that this will only be executed if a suspend action was executed previously.
EARGMPowerCapResumeLimit=40
# Format for action is: command_name current_power current_limit total_idle_nodes total_idle_power 
EARGMPowerCapResumeAction=no_action
# Sets the report plugins to use for EARGM warning and events accounting
EARGMReportPlugins=mysql.so

# EARGMs must be specified with a unique id, their node and the port that receives remote
# connections. An EARGM can also act as meta-eargm if the meta field is filled, and it will
# control the EARGMs whose ids are in said field. If two EARGMs are in the same node, 
# setting the EARGMID environment variable overrides the node field and chooses the characteristics
# of the EARGM with the correspoding id.
# 
# Only one EARGM can currently control the energy caps, so setting the rest to 0 is recommended and
# the limit applies to EARGMPeriodT2, using EARGMEnergyUnits to define the units.
# energy = 0 -> energy_cap disabled
# power = 0  -> powercap disabled
# power = N  -> powercap budget for that EARGM (and the nodes it controls) is N
# power = -1 -> powercap budget is calculated by adding up the powercap set to each of the nodes under its control.
# 				This is incompatible with nodes that have their powercap unlimited (powercap = 1)
EARGMId=1 energy=1800 power=600 node=node1 port=50100 meta=1,2
EARGMId=2 energy=0 power=500 node=node2 port=50100

# ------------------------------------------------------------------------------------------------
# Common configuration
# ------------------------------------------------------------------------------------------------
TmpDir=@localstatedir@
EtcDir=@sysconfdir@
InstDir=@prefix@
# Network extension (using another network instead of the local one). If compute nodes must be accessed from login nodes with a network different than default, and can be accesed using a expension, uncommmet next line and define 'netext' accordingly. 
# NetworkExtension=netext

# ------------------------------------------------------------------------------------------------
# Authorized Users
# ------------------------------------------------------------------------------------------------
# Authorized users, accounts and groups are allowed to change policies, thresholds, frequencies,
# etc. The special token "all" is supported.
AuthorizedUsers=usr1,usr2
AuthorizedAccounts=acc1,acc2,acc3
AuthorizedGroups=grp1,grp2

# Sets which users are considered EAR admins. These users are authorized to run EAR management
# commands. Note: AdminUsers are considered AuthorizedUsers as well.
AdminUsers=root

# -------------------------------------------------------------------------------------------------
# Tags
# -------------------------------------------------------------------------------------------------
# Tags are used for architectural descriptions. Max. AVX frequencies are used in predictor models
# and are SKU-specific. Max. and min. power are used for warning and error tracking. 
# Powercap specifies the maximum power a node is allowed to use by default. If EARGM is actively
# monitoring the cluster's powercap, max_powercap can be used to ensure that a node's power will never
# go beyond that value, regardless of the free power available cluster-wide.
# At least a default tag is mandatory to be included in this file for a cluster to work properly.

# default powercap plugin can be specified for nodes using the tag. POWERCAP=0 --> disabled, POWERCAP=1 -->unlimited, POWERCAP=N (> 1) limits node to N watts

Tag=CPU default=yes max_avx512=2.2 max_avx2=2.6 max_power=5000 min_power=50 error_power=5000 coeffs=coeffs.default powercap=1 powercap_plugin=dvfs.so energy_plug
in=energy_nm.so
Tag=GPU default=yes max_avx512=2.2 max_avx2=2.6 max_power=5000 min_power=150 error_power=5000 coeffs=coeffs.default powercap=1 powercap_plugin=dvfs.so energy_plugin=energy_nm.so  gpu_powercap_plugin=gpu.so idle_governor=ondemand idle_pstate=1000 policy=optimize


#---------------------------------------------------------------------------------------------------
## Power policies
## ---------------------------------------------------------------------------------------------------
#
## policy names must be exactly file names for policies installeled in the system
DefaultPowerPolicy=min_energy
Policy=monitoring Settings=0 DefaultPstate=0 Privileged=0
Policy=min_time Settings=0.7 DefaultPstate=4 Privileged=0
Policy=min_energy Settings=0.05 DefaultPstate=0 Privileged=1
Policy=optimize Settings=0.05 DefaultPstate=0 Privileged=0


# For homogeneous systems, default frequencies can be easily specified using freqs, for heterogeneous systems it is preferred to use pstates or use tags 

# Example with freqs (lower pstates corresponds with higher frequencies). Pstate=1 is nominal and 0 is turbo
#Policy=monitoring Settings=0 DefaultFreq=2.4 Privileged=0
#Policy=min_time Settings=0.7 DefaultFreq=2.0 Privileged=0
#Policy=min_energy Settings=0.05 DefaultFreq=2.4 Privileged=1


#Example with tags
#Policy=monitoring Settings=0 DefaultFreq=2.6 Privileged=0 tag=6126
#Policy=min_time Settings=0.7 DefaultFreq=2.1 Privileged=0 tag=6126
#Policy=min_energy Settings=0.05 DefaultFreq=2.6 Privileged=1 tag=6126
#Policy=monitoring Settings=0 DefaultFreq=2.4 Privileged=0 tag=6148
#Policy=min_time Settings=0.7 DefaultFreq=2.0 Privileged=0 tag=6148
#Policy=min_energy Settings=0.05 DefaultFreq=2.4 Privileged=1 tag=6148

#---------------------------------------------------------------------------------------------------
# Energy Tags
#---------------------------------------------------------------------------------------------------
# Privileged users,accounts and groups are allowed to use EnergyTags. The "allowed" TAGs are defined
# by row together with the priviledged user/group/account.
EnergyTag=cpu-intensive pstate=1
EnergyTag=memory-intensive pstate=4 users=usr1,usr2 groups=grp1,grp2 accounts=acc1,acc2


#---------------------------------------------------------------------------------------------------
# Node Isles
#---------------------------------------------------------------------------------------------------
# It is mandatory to specify all the nodes in the cluster, grouped by islands. More than one line
# per island must be supported to hold nodes with different names or for pointing to different
# EARDBDs through its IPs or hostnames.
#
# In the following example the nodes are clustered in two different islands, but the Island 1 have
# two types of EARDBDs configurations. 
Island=0 Nodes=node10[01-80] EARDBD_IP=node1081 EARDBD_MIRROR_IP=node1082 tag=CPU

# These nodes are in island0 using different DB connections and with a different architecture. 
# These nodes will use the same EARGM as the previous nodes.
Island=0 Nodes=node11[01-80] EARDBD_IP=node1084 EARDBD_MIRROR_IP=node1085 tag=6126
# These nodes are is island0 and will use default values for DB connection (line 0 for island0) and default tag.
Island=0 Nodes=node12[01-80] tag=GPU


# Will use default tag 
Island=1 Nodes=node11[01-80] EARDBD_IP=node1181 EARDBD_MIRROR_IP=node1182
