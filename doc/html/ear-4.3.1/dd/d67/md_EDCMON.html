<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EAR: EAR Data Center Monitoring</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo_small.png"/></td>
  <td id="projectalign">
   <div id="projectname">EAR<span id="projectnumber">&#160;4.3</span>
   </div>
   <div id="projectbrief">Reference Manual</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dd/d67/md_EDCMON.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">EAR Data Center Monitoring </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Plugin Manager is a small framework with its own thread that opens shared objects (or plugins) and executes their functions periodically. These plugins can communicate with each other through a tag system.</p>
<h1><a class="anchor" id="autotoc_md135"></a>
Creating a plugin</h1>
<p>These plugin periodic functions have to have concrete name. In plugin_manager.h you can find helper macros to define the functions and maintain your plugins updated in case of a change:</p>
<div class="fragment"><div class="line">#define declr_up_get_tag()               void   up_get_tag                 (cchar **tag, cchar **tags_deps)</div>
<div class="line">#define declr_up_action_init(suffix)     char * up_action_init##suffix     (cchar *tag, void **data_alloc, void *data)</div>
<div class="line">#define declr_up_action_periodic(suffix) char * up_action_periodic##suffix (cchar *tag, void *data)</div>
<div class="line">#define declr_up_post_data()             char * up_post_data               (cchar *msg, void *data)</div>
<div class="line"> </div>
<div class="line">#define is_tag(t) (strcmp(t, tag) == 0)</div>
<div class="line">#define is_msg(t) (strcmp(t, msg) == 0)</div>
</div><!-- fragment --><p>The function <code>get_tag</code> is in charge of returning the plugin own tag and its dependency tags. A tag matches the name of the shared object file (without the extension). The dependency tags allows the Plugin Manager to search and open the tagged plugins automatically. The format is a tag list sepparated by plus signs. Example:</p>
<div class="fragment"><div class="line">declr_up_get_tag()</div>
<div class="line">{</div>
<div class="line">    *tag = &quot;some_test&quot;;</div>
<div class="line">    *tags_deps = &quot;dependency1+!dependency2&quot;;</div>
<div class="line">}</div>
</div><!-- fragment --><p>If a dependency tag starts with an exclamation mark '!', it means that dependency is mandatory for the loading plugin, and in case it is not resolved the loading plugin will be disabled. The symbol '&lt;' tells the Plugin Manager to inherit the timing of the dependant plugin.</p>
<p>The function <code>action_periodic</code> is the core function and is called periodically at a time specified when loading the framework as we will se below. It receives a tag and a data pointer associated with that tag. The received tag could be the self tag or the tag of other plugins. Below you will find more about the calling pipeline and the priority system.</p>
<p>Examples of action_periodic function types: </p><div class="fragment"><div class="line">declr_up_action_periodic(_tag1)</div>
<div class="line">{</div>
<div class="line">    type1_t *d = (type1_t *) data;</div>
<div class="line">    // work</div>
<div class="line">    return NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">declr_up_action_periodic()</div>
<div class="line">{</div>
<div class="line">    if (is_tag(&quot;tag2&quot;)) {</div>
<div class="line">        type2_t *d = (type2_t *) data;</div>
<div class="line">        // work</div>
<div class="line">    }</div>
<div class="line">    return NULL;</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can use the macro <code>is_tag</code> to distinguish between tags or use suffix in the declaration macro to be called only for specific tags, freeing your code from conditionals. The <code>action_periodic_init</code> is called once at the beginning of the execution and serves as data allocator through <code>data_alloc</code> pointer. These functions return a char pointer containing a message to print or NULL in case you don't want to print anything.</p>
<p>The returning char is a message that Plugin Manager will print in case is not NULL. You can add some modifiers at the beginning of the message:</p><ul>
<li><code>[D]</code> disables the plugin. It also re-activates the dependency system and could disable dependant plugins.</li>
<li><code>[=]</code> pauses the periodic call.</li>
<li><code>[X]</code> closes the Plugin Manager main thread.</li>
</ul>
<p>Finally, <code>post_data</code> allows to receive external data to the plugin. In example, if Plugin Manager is being used by the EARD, when a job starts you could send a message to the framework containing the job and step IDs. By now you can distinguish the messages by <code>is_msg</code> macro. Maybe in the near future we implement the suffix system too.</p>
<p>You can find examples of plugins in <code>data_center_monitoring/plugins</code> folder.</p>
<h1><a class="anchor" id="autotoc_md136"></a>
The Plugin Manager framework</h1>
<p>By now these are the functions of the framework:</p>
<div class="fragment"><div class="line">// Init as main binary function</div>
<div class="line">int plugin_manager_main(int argc, char *argv[]);</div>
<div class="line"> </div>
<div class="line">// Init as a component of a binary</div>
<div class="line">int plugin_manager_init(char *files, char *paths);</div>
<div class="line"> </div>
<div class="line">// Closes Plugin Manager main thread.</div>
<div class="line">void plugin_manager_close();</div>
<div class="line"> </div>
<div class="line">// Wait until Plugin Manager exits.</div>
<div class="line">void plugin_manager_wait();</div>
<div class="line"> </div>
<div class="line">// Asking for an action. Intended to be called from plugins.</div>
<div class="line">void *plugin_manager_action(cchar *tag);</div>
<div class="line"> </div>
<div class="line">// Passing data to plugins. Intended to be called outside PM.</div>
<div class="line">void plugin_mananger_post(cchar *msg, void *data);</div>
</div><!-- fragment --><p>There are two initializing functions: <code>plugin_manager_main</code> and <code>plugin_manager_init</code>. <code>plugin_manager_main</code> receives the binary main arguments and <code>plugin_manager_init</code> a list of loaded plugins and search paths. This is an example of binary arguments and its format:</p>
<div class="fragment"><div class="line">./bin --plugins=metrics.so:2000+periodic_metrics.so:4000 --paths=path/to/plugins1:path/to/plugins2</div>
</div><!-- fragment --><p>The list of plugins contains their calling time in milliseconds. Additional colon can be provided to pass information to a plugin. In that case that information would be delivered as string through the <code>data</code> pointer in <code>up_action_init</code> function. In example:</p>
<div class="fragment"><div class="line">./bin --plugins=metrics.so:2000+periodic_metrics.so:4000:config_message --paths=path/to/plugins1:path/to/plugins2</div>
</div><!-- fragment --><p>In this example, <code>metrics.so</code> would be called every 2 seconds and also would feed <code>periodic_metrics.so</code> with metrics data. But <code>periodic_metrics.so</code> with its own tag and allocated data, would be called every 4 seconds. In case the time is not specified, is considered an <code>init</code> plugin.</p>
<p>As previously explained, <code>plugin_mananger_post</code> is used to pass information to the plugins. <code>plugin_manager_action</code> is intended to be called from plugins, to call other plugin specificed by its tag and return its data. Lastly <code>plugin_manager_wait</code> waits indefinitely until the end of the Plugin Manager thread. The usage is the following:</p>
<div class="fragment"><div class="line">Usage: ./bin [OPTIONS]</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">    --plugins    List of comma separated plugins to load.</div>
<div class="line">    --paths      List of comma separated priority paths to search plugins.</div>
<div class="line">    --verbose    Show how the things are going internally.</div>
<div class="line">    --silence    Hide messages returned by plugins.</div>
<div class="line">    --help       If you see it you already typed --help.</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md137"></a>
Calling pipeline and priority system</h1>
<p>When time is up for a specific plugin, in example <code>specific.so</code>, its <code>action_periodic</code> or <code>action_periodic_specific</code> function is called. After the return, the <code>action_periodic</code> or <code>action_periodic_specific</code> function of the rest of the other plugins are called with the <code>specific</code> tag and <code>specific</code> data pointer. In case of <code>action_init</code> or if multiple plugins share the periodic time, the calling order is determined by a priority system.</p>
<p>The priority system takes into the account the order written in <code>--plugins</code> parameter, but also the dependencies. If a plugin A is a dependency of plugin B, plugin A will be called before. If a plugin C was written before plugin D and both share the same periodic time, plugin C will be called before plugin D.</p>
<p>If a Plugin C is written before plugin D in the <code>--plugins</code> parameter, but C depends on D, D will be called before. These rare cases are contemplated in the dependency system algorithmics.</p>
<h1><a class="anchor" id="autotoc_md138"></a>
FAQ</h1>
<ul>
<li><b>Can I load the same plugin twice?</b> No.</li>
<li><b>Is the tag mandatory value?</b> Yes, all the plugins require a tag.</li>
<li><b>And the dependency tags?</b> Can be set to NULL if the plugin does not have any dependency.</li>
<li><b>Do I have to specify the time of a plugin in the dependency list?</b> No, is not recommended. A plugin which is loaded by the dependency list instead using the <code>--plugins</code> parameter inherits the dependent plugin time if using the special character '&lt;' at the beginning of the string.</li>
<li><b>If none of the dependencies are resolved, the plugin periodic function will be called anyways?</b> Depends if some of the dependencies are mandatory, specified by the exclamation mark (!).</li>
<li><b>What happens if a plugin has periodic time specified but haven't defined a periodic function?</b> If there is no periodic function, nothing will be called.</li>
<li><b>Do I have to define all the API functions in the plugin?</b> No, only those necessary for the correct plugin functionality. The <code>get_tag</code> function is the exception because the tag is a mandatory value.</li>
<li><b>Can <code>action_init</code> function be defined but <code>action_periodic</code> not?</b> Yes. Sometimes you want to perform an action just once and you can do it in the init function. In example, the job of the plugin <code>conf.so</code> is to read <code>ear.conf</code> and pass the configuration structure to the rest of loading plugins.</li>
<li><b>For a plugin which does not allocate data, is its periodic function called?</b> Yes, if it's defined. But the NULL value in the allocated data pointer disallows any information exchange, so periodic function of other plugins wont be called.</li>
<li><b>If a plugin has defined the a function <code>action_periodic_specific</code> for the tag <code>specific</code>, but also the general <code>action_periodic</code>, which of the two would be called?</b> For the <code>specific</code> tag <code>action_periodic_specific</code> would be called. For the rest of the tags the general <code>action_periodic</code>. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
